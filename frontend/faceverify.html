<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Face Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">

<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body, html {
      height: 100%;
      width: 100%;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #a8edea, #fed6e3);
      background-size: 200% 200%;
      animation: gradientAnimation 15s ease infinite;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    @keyframes gradientAnimation {
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    .verify-card {
      background: rgba(255, 255, 255, 0.65);
      border-radius: 25px;
      padding: 2rem 3rem;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      max-width: 600px;
      width: 100%;
      height: 90%;
      animation: fadeInUp 1s ease forwards;
      text-align: center;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h2 {
      margin-bottom: 1.5rem;
      font-size: 2rem;
      color: #444;
    }

    .scan-box {
      width: 400px;
      height: 400px;
      margin: 0 auto 1.5rem;
      border: 3px solid rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.05);
      box-shadow: inset 2px 2px 5px #d1d9e6, inset -2px -2px 5px #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .btn-verify {
      width: 40%;
      margin-block: 1rem;
      padding: 0.8rem;
      border: none;
      border-radius: 40px;
      background: linear-gradient(to right, #c2e9fb, #a1c4fd);
      box-shadow: 8px 8px 15px #d1d9e6, -8px -8px 15px #ffffff;
      font-size: 1.1rem;
      font-weight: 600;
      color: #444;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-verify:hover {
      background: #d0e8ff;
      color: #2a72d8;
      transform: scale(1.03);
      box-shadow: inset 8px 8px 15px #d1d9e6, inset -8px -8px 15px #ffffff;
    }

    .reg-link {
      margin-top: 1rem;
    }

    .reg-link a {
      color: #2a72d8;
      text-decoration: none;
      font-weight: 500;
    }

    .reg-link a:hover {
      text-decoration: underline;
    }

    #result-box {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 0.8rem;
    }
</style>
</head>
<body>

<div class="verify-card">
  <h2>Face Verification</h2>
  <div class="scan-box">
    <video id="camera" autoplay playsinline></video>
  </div>
  <p id="result-box"></p>
  <button class="btn-verify">Verify Face</button>
  <div class="reg-link">
    <p>Not registered? <a href="reg.html">Register</a></p>
  </div>
</div>

<script>
  const video = document.getElementById('camera');
  const verifyBtn = document.querySelector('.btn-verify');
  const resultBox = document.getElementById('result-box');

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (error) {
      alert('Camera access denied or unavailable.');
      console.error(error);
    }
  }

  async function captureAndVerify() {
    // Capture frame
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
    const formData = new FormData();
    formData.append("file", blob, "capture.jpg");

    resultBox.innerText = "Verifying...";
    resultBox.style.color = "black";

    try {
      const response = await fetch("http://127.0.0.1:8000/verify-face", {
        method: "POST",
        body: formData
      });

      console.log(response)

      const result = await response.json();

      console.log(result);

      if (result.status === "matched") {
        resultBox.innerText = `Face Verified! Redirecting...`;
        resultBox.style.color = "green";
        // Redirect to profile page with name parameter
        window.location.href = `profile.html?name=${encodeURIComponent(result.name)}`;
      } else if (result.status === "no_face") {
        resultBox.innerText = "No face detected!";
        resultBox.style.color = "orange";
      } else {
        resultBox.innerText = "No face matched! Register to vote below.";
        resultBox.style.color = "red";
      }
    } catch (err) {
      console.error(err);
      resultBox.innerText = "Error connecting to server!";
      resultBox.style.color = "red";
    }
  }

  verifyBtn.addEventListener("click", captureAndVerify);
  startCamera();
</script>

</body>
</html>
